# 工作流的名称，会显示在 GitHub 的 "Actions" 页面
name: Build and Deploy Jekyll site to GitHub Pages

# 触发工作流的条件
on:
  # 当有代码被推送到 "main" 分支时，自动运行此工作流
  push:
    branches:
      - main
  
  # 同时也允许您在 Actions 页面手动触发此工作流
  workflow_dispatch:

# 设置工作流任务需要的权限
permissions:
  contents: read      # 允许读取仓库内容
  pages: write        # 允许写入 GitHub Pages
  id-token: write     # 允许进行身份验证

# 设置并发控制，避免同时运行多个由同一分支触发的工作流
concurrency:
  group: "pages"
  cancel-in-progress: false

# 定义工作流中的所有任务
jobs:
  # 定义一个名为 "build" 的构建任务
  build:
    runs-on: ubuntu-latest # 使用最新的 Ubuntu 虚拟机作为运行环境
    steps:
      # 第一步：拉取您的仓库代码
      - name: Checkout
        uses: actions/checkout@v4
      
      # 第二步：设置 Ruby 环境，并利用缓存加速依赖安装
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1' # 使用一个稳定且推荐的 Ruby 版本
          bundler-cache: true # 缓存 Gem 依赖，让未来的构建更快
          cache-version: 0 # 如果依赖安装出问题，可以修改这个数字来强制清除缓存

      # 第三步：构建 Jekyll 网站，并将结果输出到 ./_site 文件夹
      - name: Build with Jekyll
        run: bundle exec jekyll build
        env:
          JEKYLL_ENV: production # 设置环境变量为“生产模式”

      # 第四步：将构建好的 _site 文件夹打包上传，以供部署任务使用
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  # 定义一个名为 "deploy" 的部署任务
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }} # 设置部署环境的URL，方便在日志中点击
    runs-on: ubuntu-latest
    needs: build # 此任务必须等待 "build" 任务成功完成后才能开始
    steps:
      # 部署步骤：从之前上传的产物中获取网站文件，并将其部署到 GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
